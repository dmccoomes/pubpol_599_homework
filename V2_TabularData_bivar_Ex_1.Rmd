<br> 
<center><img src="http://i.imgur.com/sSaOozN.png" width="500"></center>

## Course: Visual Analytics for Policy and Management

### Prof. Jos√© Manuel Magallanes, PhD 

_____
<a id='part1'></a>

# Part 2: Visualizing Tabular data

### [Bivariate Case](https://github.com/EvansDataScience/VisualAnalytics_2_tabularDataBiv)

_____

Contents:

1. [Intro.](#part1)

2. [Categorical-Categorical case.](#part2) 

3. [Categorical-Numerical case.](#part3)

4. [Numerical-Numerical case.](#part4)

**Exercises**: <br>

- [Exercise 1](#ex1)
- [Exercise 2](#ex2)
- [Exercise 3](#ex3)
- [Exercise 4](#ex4)

_____

We analyze two variables to find out if there might be some kind of association between them. Even though that may be difficult to clearly identify, bivariate analysis still helps reveal _signs_ of association that may serve at least to raise concern.

As before, the nature of the data allows for some particular analytical techniques, while also providing some limitations to our inferences. Let's see what we can visualize with the different combinations of data.

This time, I will use the [data about crime](https://data.seattle.gov/Public-Safety/Crime-Data/4fs7-3vj5) from the Seattle Open Data portal:

```{r collect, eval=FALSE}
link="https://github.com/EvansDataScience/data/raw/master/crime.RData"
load(file = url(link))
```


The data available are:

```{r names, eval=FALSE}
names(crime)
```

A quick look will give us:
```{r head, eval=FALSE}
head(crime)
```

Let's see what kind of data we have:

```{r str, eval=FALSE}
str(crime,width = 70,strict.width='cut')
```


_____

[Go to table of contents.](#part1)

<a id='part2'></a>

## Categorical-Categorical relationships

The main way to organize these relationships are the contingency tables. Let's select a couple of categorical variables:

```{r table, eval=FALSE}
(CrimeTotal=table(crime$crimecat,crime$Occurred.DayTime))
```


The table above shows counts, but in most situations, it is important to see relative values:

```{r table_rel_PIPES,eval=FALSE}
# using "pipes" to help readability:
library(magrittr)
(CrimeTotal=table(crime$crimecat,crime$Occurred.DayTime)%>% #create table and then...
        prop.table() %>% #compute proportion and then...
        "*"(100)%>% # multiply by 100 and then...
        round(2) #...round to to decimals
        )
```

Those tables show total counts or percents. However, when a table tries to hypothesize a relationship, you should have the _independent_ variable in the columns, and the _dependent_ one in the rows; then, the percent should be calculated by column, to see how the levels of the dependent variable varies by each level of the independent one, and compare along rows.


```{r table_byCol,eval=FALSE}
CrimeCol=table(crime$crimecat,crime$Occurred.DayTime)%>%
         prop.table(margin = 2)%>%   # 2 is % by column
         "*"(100)%>%
         round(3)

CrimeCol
```



The complexity of two variables requires plots, as tables like these will not allow you to discover *association patterns* easily, even though they are already a summary of two columns. However, you must check the data format the plotting functions require, as most plots will use the contingency table as input (not the raw data).

As before, we can use the bar plot with the contingency table as input:

```{r BADplot,eval=FALSE}
barplot(CrimeCol)
```

This plot will need a lot of work, so the base capabilities of R may not be a good strategy.  

However, when using alternative/more specialized plotting features you may need to convert your table into a dataframe of frequencies, let me create the base proportions table:

```{r convertToDFgg,eval=FALSE}
df.T=as.data.frame(CrimeTotal) # table of proportion based on total
# YOU GET:
head(df.T)
```

We should rename the above table:
```{r, eval=FALSE}
names(df.T)=c('Crime','Daytime','Percent') #renaming
head(df.T)
```

A first option you may have is to reproduce the table:
```{r plotTable_gg, eval=FALSE}
library(ggplot2)                           
base = ggplot(df.T, aes(Daytime,Crime)) 
# plot value as point, size by value of percent
tablePlot1 = base + geom_point(aes(size = Percent), colour = "gray") 
# add value of Percent as label, move it
tablePlot2 = tablePlot1 + geom_text(aes(label = Percent),
                                    nudge_x = 0.1,
                                    size=2)
tablePlot2
```

...some more work:
```{r, eval=FALSE}
tablePlot3 = tablePlot2 + scale_size_continuous(range=c(0,10)) #change 10?
tablePlot4 = tablePlot3 + theme_minimal() # less ink
tablePlot4 + theme(legend.position="none") # no legend
```



The plot looks nice, but unless the differences are clearly cut, you may see more noise than information, which distracts and delays decision making. Keep in mind that _length_ of bars are easier to compare than circle _areas_. You need a barplot, but with better tools:

```{r facet, eval=FALSE}
base  = ggplot(df.T, aes(x = Crime, y = Percent ) ) 
bars1 = base + geom_bar( stat = "identity" ) + theme_minimal()
# bar per day time with 'facet'
bars2 = bars1 + facet_wrap( ~ Daytime ,nrow = 1) 
bars2 
```

...some more work:

```{r, eval=FALSE}
# change the minimal theme
bars3 = bars2 + theme( axis.text.x = element_text(angle = 90,
                                                  hjust = 1,
                                                  size=3 ) )
bars3
```


And, the original relationship Input-Output table can be plotted like this:

```{r flip_facet, eval=FALSE}
df.C=as.data.frame(CrimeCol)
colnames(df.C)=c('Crime','Daytime','Percent')
#####

base  = ggplot(df.C, aes(x = Crime, y = Percent ) ) 
bars1 = base + geom_bar( stat = "identity" )
bars2 = bars1 + facet_wrap( ~ Daytime ,nrow = 1) 
bars2 + coord_flip()
```

The type of crime is not ordinal, then we could reorder the bars:

```{r orderFacet, eval=FALSE}
base  = ggplot(df.C, aes(x = reorder(Crime, Percent), y = Percent ) ) 
bars1 = base + geom_bar( stat = "identity" )
bars2 = bars1 + facet_wrap( ~ Daytime ,nrow = 1) 
bars2 + coord_flip() + theme(axis.text.y = element_text(size=4,angle = 45)) 
```

<a id='ex1'></a>
<span style="color:red"> Exercise 1:<br> Turn the bars into lollipop with the right components.
</span>

DMC - Starting excercise 1

```{r lolliplot_EX1, eval=FALSE}
df.C_ord=df.C[order(df.C$Percent),]
base = ggplot(df.C_ord, aes(x = reorder(Crime, Percent), y = Percent))
#base = ggplot(df.C_ord, aes(x=Crime, y=Percent))
loliplot1 = base + geom_segment(aes(y = 0, 
                                   x = reorder(Crime, Percent), 
                                   yend = Percent, 
                                   xend = Crime), color = "grey50") 

loliplot2 = loliplot1 + geom_point()

loliplot3 = loliplot2 + facet_wrap( ~Daytime, nrow=1)

loliplot3 + coord_flip()
```







